{"version":3,"sources":["../../src/bootstrap/requires-writer.js"],"names":["_","require","fs","crypto","store","emitter","lastHash","resetLastHash","pickComponentFields","page","pick","getComponents","pages","map","uniqBy","c","componentChunkName","value","getMatchPaths","filteredPaths","forEach","index","matchPath","push","score","split","length","sort","a","b","order","path","createHash","matchPaths","components","update","JSON","stringify","digest","writeAll","state","program","values","newHash","Promise","resolve","syncRequires","component","join","asyncRequires","writeAndMove","file","data","destination","directory","tmp","Date","now","writeFile","then","move","overwrite","result","all","debouncedWriteAll","debounce","getState","leading","startListener","on","module","exports"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst fs = require(`fs-extra`)\nconst crypto = require(`crypto`)\nconst { store, emitter } = require(`../redux/`)\nimport { joinPath } from \"gatsby-core-utils\"\n\nlet lastHash = null\n\nconst resetLastHash = () => {\n  lastHash = null\n}\n\nconst pickComponentFields = page =>\n  _.pick(page, [`component`, `componentChunkName`])\n\nconst getComponents = pages =>\n  _(pages)\n    .map(pickComponentFields)\n    .uniqBy(c => c.componentChunkName)\n    .value()\n/**\n * Get all dynamic routes and sort them by most specific at the top\n * code is based on @reach/router match utility (https://github.com/reach/router/blob/152aff2352bc62cefc932e1b536de9efde6b64a5/src/lib/utils.js#L224-L254)\n */\nconst getMatchPaths = pages => {\n  const filteredPaths = []\n  pages.forEach((page, index) => {\n    if (page.matchPath) {\n      filteredPaths.push({\n        ...page,\n        index,\n        score: page.matchPath.split(`/`).length,\n      })\n    }\n  })\n\n  return filteredPaths\n    .sort((a, b) => {\n      // The higher the score, the higher the specificity of our matchPath\n      const order = b.score - a.score\n      if (order !== 0) {\n        return order\n      }\n\n      // if specificty is the same we use the array index\n      return b.index - a.index\n    })\n    .map(({ path, matchPath }) => {\n      return { path, matchPath }\n    })\n}\n\nconst createHash = (matchPaths, components) =>\n  crypto\n    .createHash(`md5`)\n    .update(JSON.stringify({ matchPaths, components }))\n    .digest(`hex`)\n\n// Write out pages information.\nconst writeAll = async state => {\n  const { program } = state\n  const pages = [...state.pages.values()]\n  const matchPaths = getMatchPaths(pages)\n  const components = getComponents(pages)\n\n  const newHash = createHash(matchPaths, components)\n\n  if (newHash === lastHash) {\n    // Nothing changed. No need to rewrite files\n    return Promise.resolve()\n  }\n\n  lastHash = newHash\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `const { hot } = require(\"react-hot-loader/root\")\n\n// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": hot(preferDefault(require(\"${joinPath(\n          c.component\n        )}\")))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": () => import(\"${joinPath(\n          c.component\n        )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  const result = await Promise.all([\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n    writeAndMove(`match-paths.json`, JSON.stringify(matchPaths, null, 4)),\n  ])\n\n  return result\n}\n\nconst debouncedWriteAll = _.debounce(() => writeAll(store.getState()), 500, {\n  leading: true,\n})\n\n/**\n * Start listening to CREATE/DELETE_PAGE events so we can rewrite\n * files as required\n */\nconst startListener = () => {\n  emitter.on(`CREATE_PAGE`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`CREATE_PAGE_END`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE_BY_PATH`, () => {\n    debouncedWriteAll()\n  })\n}\n\nmodule.exports = {\n  writeAll,\n  resetLastHash,\n  startListener,\n}\n"],"file":"requires-writer.js"}